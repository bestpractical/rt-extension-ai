(function(d,u){typeof exports=="object"&&typeof module<"u"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(d=typeof globalThis<"u"?globalThis:d||self,u(d.RtExtensionAi={}))})(this,function(d){"use strict";async function u(n,e){try{const r=p(window.location.href),t=await fetch(RT.Config.WebHomePath+"/Helpers/AISuggestion/ProcessAIRequest",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({rawText:n,callType:e,...r&&{id:r}}).toString()});if(!t.ok)return console.error("Error in fetchAiResults:",t.status,t.statusText),"No suggestion available.";const o=await t.text();return o||(console.warn("No suggestion found in response:",o),"No suggestion available.")}catch(r){return console.error("Error fetching AI results:",r),"No suggestion available."}}function E(n){let e="",r=!1;const t=n.model.document.selection;if(!t.isCollapsed){const o=t.getFirstRange();if(o){for(const s of o.getItems())s.is("$textProxy")&&(e+=s.data);r=!0}}return{content:r?e:n.data.get(),isSelected:r}}function w(n){return new DOMParser().parseFromString(n,"text/html").body.textContent||""}function b(n){if(!/<\/?[a-z][\s\S]*>/i.test(n))return n.trim();const t=new DOMParser().parseFromString(n,"text/html");return Array.from(t.querySelectorAll("p")).map(s=>{var a;return((a=s.textContent)==null?void 0:a.trim())||""}).filter(Boolean).join(`
`)}function p(n){try{const e=new URL(n);if(e.pathname.includes("Ticket")){let r=e.search;r=r.slice(1).replace(/;/g,"&");const t=new URLSearchParams(r);if(t.has("id")){const o=parseInt(t.get("id"),10);return isNaN(o)?(console.error("The 'id' parameter is not a valid number."),null):o}}}catch(e){return console.error("Error parsing the URL:",e),null}return null}function v(){const n=window.location.href,e=window.RT_AI_ActiveForCurrentQueue,r=n.includes("Ticket/Update.html")||n.includes("Ticket/Create.html");return e&&r?1:0}function T(n,e){if(!e||!n){console.error("Invalid suggestion or editor instance.");return}n.model.change(r=>{const t=n.model.document.getRoot();n.model.markers.has("autocompleteSuggestion")&&r.removeMarker("autocompleteSuggestion");const o=n.model.document.selection.getFirstPosition()||r.createPositionAt(t,"end"),s=r.createRange(o,o);r.addMarker("autocompleteSuggestion",{range:s,usingOperation:!1,affectsData:!1}),I(n,e)})}function I(n,e){if(!e||!n){console.error("Invalid suggestion or editor instance.");return}const r="placeholder-autocomplete-style";if(!document.getElementById(r)){const o=document.createElement("style");o.id=r,o.innerHTML=`
            .placeholder-autocomplete-text {
                color: gray;
                opacity: 0.5;
            }
        `,document.head.appendChild(o)}let t=null;n.editing.view.change(o=>{const s=n.model.document.selection,a=o.createText(e);t=o.createContainerElement("span",{class:"placeholder-autocomplete-text"});const i=n.editing.mapper.toViewPosition(s.getFirstPosition());i&&(o.insert(i,t),o.insert(o.createPositionAt(t,0),a))}),n.keystrokes.set("Tab",(o,s)=>{t&&(n.model.change(a=>{const i=n.model.document.selection.getFirstPosition();if(i){a.insertText(e,i);const l=a.createPositionAt(i.parent,i.offset+e.length);a.setSelection(l),n.editing.view.change(m=>{m.remove(t)}),t=null}}),s())}),n.ui.view.editable.element.addEventListener("click",()=>{t&&(n.editing.view.change(o=>{o.remove(t)}),t=null)}),document.addEventListener("click",o=>{!n.ui.view.editable.element.contains(o.target)&&t&&(n.editing.view.change(a=>{a.remove(t)}),t=null)}),n.model.document.on("change:data",()=>{t&&(n.editing.view.change(o=>{o.remove(t)}),t=null)})}class A{constructor(){this.modalInstance=null,this.modalElement=null,this.close=this.close.bind(this)}checkBootstrapAvailability(){return typeof bootstrap>"u"?(console.error("Bootstrap is not available. Make sure it is properly loaded."),!1):!0}open(e){if(!this.checkBootstrapAvailability())return!1;try{this.closeExistingModal();const r=document.createElement("div");r.innerHTML=e.trim();const t=r.querySelector("#aiModal");return t?(r.removeChild(t),document.body.appendChild(t),this.modalElement=t,this.modalInstance=new bootstrap.Modal(t,{backdrop:!0,keyboard:!0}),this.modalInstance.show(),this.setupCloseHandlers(t),!0):(console.error("Modal element #aiModal not found in the provided content"),!1)}catch(r){return console.error("Error opening modal:",r),!1}}setupCloseHandlers(e){e.querySelectorAll('.close, .btn-close, [data-bs-dismiss="modal"]').forEach(t=>{t.removeEventListener("click",this.close.bind(this)),t.addEventListener("click",this.close.bind(this))})}closeExistingModal(){try{this.modalInstance&&(this.modalInstance.hide(),this.modalInstance.dispose(),this.modalInstance=null),this.modalElement&&this.modalElement.parentNode&&this.modalElement.parentNode.removeChild(this.modalElement),document.querySelectorAll(".modal-backdrop").forEach(r=>{r&&r.parentNode&&r.parentNode.removeChild(r)}),document.body.classList.remove("modal-open"),document.body.style.removeProperty("padding-right"),document.body.style.removeProperty("overflow"),this.modalElement=null}catch(e){console.warn("Error disposing existing modal:",e)}}close(){try{this.modalInstance&&(this.modalInstance.hide(),this.modalInstance.dispose(),this.modalInstance=null),this.modalElement&&this.modalElement.parentNode&&this.modalElement.parentNode.removeChild(this.modalElement),this.modalElement=null}catch(e){console.warn("Error closing modal:",e),this.modalElement&&this.modalElement.parentNode&&this.modalElement.parentNode.removeChild(this.modalElement),document.querySelectorAll(".modal-backdrop").forEach(t=>{t.parentNode.removeChild(t)}),document.body.classList.remove("modal-open"),document.body.style.removeProperty("padding-right"),document.body.style.removeProperty("overflow")}}}async function x(n,e={}){const r=new URLSearchParams(e).toString(),t=`${n}?${r}`;try{const o=await fetch(t,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!o.ok)throw new Error(`Failed to fetch modal content: ${o.status} ${o.statusText}`);return await o.text()}catch(o){throw console.error("Error loading modal content:",o),o}}function S(n){if(!n||!n.model||!n.model.document)return console.warn("Editor not properly initialized when trying to save selection"),{ranges:[],attributes:[]};const e=n.model.document.selection,r=Array.from(e.getRanges()).map(o=>o.clone()),t=Array.from(e.getAttributes());return{ranges:r,attributes:t}}function P(n,e){if(!n||!n.model){console.warn("Editor not properly initialized when trying to restore selection");return}if(!e||!e.ranges){console.warn("Invalid saved selection when trying to restore");return}n.model.change(r=>{try{r.setSelection(e.ranges);for(const[t,o]of e.attributes)r.setSelectionAttribute(t,o)}catch(t){console.error("Error restoring editor selection:",t)}})}async function R(n,e,r="suggest_response",t=!1){if(!e||!e.model){console.error("Editor not properly initialized");return}try{if(typeof bootstrap>"u"){console.error("Bootstrap is required but not available");return}n=b(n);const o=S(e);let s;try{s=await x(RT.Config.WebHomePath+"/Helpers/AISuggestion/ShowModal",{rawText:n,callType:r,TicketId:p(window.location.href)})}catch(l){console.error("Failed to load modal content:",l),alert("Failed to load AI suggestion modal. Please try again later.");return}const a=new A;if(!a.open(s)){console.error("Failed to open modal");return}setTimeout(()=>{try{const l=a.modalElement.querySelector('[name="done-button"]'),m=a.modalElement.querySelector('[name="ai-result"]');if(!m){console.error("suggestionText element not found in modal content");return}typeof htmx<"u"&&htmx.process(a.modalElement),l?(l.replaceWith(l.cloneNode(!0)),a.modalElement.querySelector('[name="done-button"]').addEventListener("click",()=>{var f;const g=(f=m==null?void 0:m.innerText)==null?void 0:f.replace(/^\s*|\s*$/g,"").trim();if(!g){console.warn("No AI response to insert"),a.close();return}try{e.model.change(c=>{try{const h=e.data.toModel(e.data.processor.toView(g));if(!o.ranges.length||!t){const y=e.model.document.getRoot();c.setSelection(null),c.remove(c.createRangeIn(y)),c.insert(h,c.createPositionAt(y,0))}else P(e,o),e.model.insertContent(h,e.model.document.selection);const k=e.model.document.getRoot(),M=c.createPositionAt(k,"end");c.setSelection(M),setTimeout(()=>{e.editing.view.focus()},100)}catch(h){console.error("Error inserting content into editor:",h),alert("Failed to insert AI suggestion into the editor.")}})}catch(c){console.error("Error applying editor changes:",c)}a.close()})):console.warn("Done button not found in modal content")}catch(l){console.error("Error setting up modal interaction:",l)}},100)}catch(o){console.error("Error creating suggestion modal:",o),alert("An error occurred while creating the AI suggestion modal.")}}class C extends CKEDITOR.Plugin{static get pluginName(){return"RtExtensionAi"}init(){const e=this.editor;v()&&(this.addDropdown(e),this.addAutoComplete(e))}addDropdown(e){e.ui.componentFactory.add("aiSuggestion",r=>{const t=new CKEDITOR.Collection;t.add(this.createDropdownItem("Adjust Tone/Voice","adjust_tone")),t.add(this.createDropdownItem("AI Suggestion","suggest_response")),t.add(this.createDropdownItem("Translate","translate_content"));const o=CKEDITOR.createDropdown(r,CKEDITOR.DropdownButtonView);return CKEDITOR.addListToDropdown(o,t),o.buttonView.set({label:"AI Assist",tooltip:!0,withText:!0}),o.on("execute",async s=>{const{id:a}=s.source,{content:i,isSelected:l}=E(e);R(i,e,a,l)}),o})}addAutoComplete(e){let r=null,t=!1;e.model.document.on("change:data",()=>{clearTimeout(r),r=setTimeout(async()=>{if(t){t=!1;return}const o=w(e.data.get().trim());if(o)try{const s=await u(o,"autocomplete_text");s&&(T(e,s),t=!0)}catch(s){console.error("Error during auto-complete:",s)}},500)})}createDropdownItem(e,r){return{type:"button",model:{label:e,id:r,withText:!0}}}}d.RtExtensionAi=C,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
