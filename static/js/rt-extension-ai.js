(function(m,h){typeof exports=="object"&&typeof module<"u"?h(exports):typeof define=="function"&&define.amd?define(["exports"],h):(m=typeof globalThis<"u"?globalThis:m||self,h(m.RtExtensionAi={}))})(this,function(m){"use strict";async function h(o,e){var r;try{const t=f(window.location.href);let n;t||(n=(r=document.querySelector("#ai-queue"))==null?void 0:r.getAttribute("data-id"));const s=await fetch(RT.Config.WebHomePath+"/Helpers/AISuggestion/ProcessAIRequest",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({rawText:o,callType:e,...t&&{id:t},...n&&{QueueId:n}}).toString()});if(!s.ok)return console.error("Error in fetchAiResults:",s.status,s.statusText),"No suggestion available.";const a=await s.text();return a||(console.warn("No suggestion found in response:",a),"No suggestion available.")}catch(t){return console.error("Error fetching AI results:",t),"No suggestion available."}}function I(o){let e="",r=!1;const t=o.model.document.selection;if(!t.isCollapsed){const n=t.getFirstRange();if(n){for(const s of n.getItems())s.is("$textProxy")&&(e+=s.data);r=!0}}return{content:r?e:o.data.get(),isSelected:r}}function T(o){return new DOMParser().parseFromString(o,"text/html").body.textContent||""}function b(o){if(!/<\/?[a-z][\s\S]*>/i.test(o))return o.trim();const t=new DOMParser().parseFromString(o,"text/html");return Array.from(t.querySelectorAll("p")).map(s=>{var a;return((a=s.textContent)==null?void 0:a.trim())||""}).filter(Boolean).join(`
`)}function f(o){try{const e=new URL(o);if(e.pathname.includes("Ticket")){let r=e.search;r=r.slice(1).replace(/;/g,"&");const t=new URLSearchParams(r);if(t.has("id")){const n=parseInt(t.get("id"),10);return isNaN(n)?(console.error("The 'id' parameter is not a valid number."),null):n}}}catch(e){return console.error("Error parsing the URL:",e),null}return null}function v(){const o=window.location.href,e=window.RT_AI_ActiveForCurrentQueue,r=o.includes("Ticket/Update.html")||o.includes("Ticket/Create.html");return e&&r?1:0}function A(o,e){if(!e||!o){console.error("Invalid suggestion or editor instance.");return}o.model.change(r=>{const t=o.model.document.getRoot();o.model.markers.has("autocompleteSuggestion")&&r.removeMarker("autocompleteSuggestion");const n=o.model.document.selection.getFirstPosition()||r.createPositionAt(t,"end"),s=r.createRange(n,n);r.addMarker("autocompleteSuggestion",{range:s,usingOperation:!1,affectsData:!1}),x(o,e)})}function x(o,e){if(!e||!o){console.error("Invalid suggestion or editor instance.");return}const r="placeholder-autocomplete-style";if(!document.getElementById(r)){const n=document.createElement("style");n.id=r,n.innerHTML=`
            .placeholder-autocomplete-text {
                color: gray;
                opacity: 0.5;
            }
        `,document.head.appendChild(n)}let t=null;o.editing.view.change(n=>{const s=o.model.document.selection,a=n.createText(e);t=n.createContainerElement("span",{class:"placeholder-autocomplete-text"});const i=o.editing.mapper.toViewPosition(s.getFirstPosition());i&&(n.insert(i,t),n.insert(n.createPositionAt(t,0),a))}),o.keystrokes.set("Tab",(n,s)=>{t&&(o.model.change(a=>{const i=o.model.document.selection.getFirstPosition();if(i){a.insertText(e,i);const d=a.createPositionAt(i.parent,i.offset+e.length);a.setSelection(d),o.editing.view.change(l=>{l.remove(t)}),t=null}}),s())}),o.ui.view.editable.element.addEventListener("click",()=>{t&&(o.editing.view.change(n=>{n.remove(t)}),t=null)}),document.addEventListener("click",n=>{!o.ui.view.editable.element.contains(n.target)&&t&&(o.editing.view.change(a=>{a.remove(t)}),t=null)}),o.model.document.on("change:data",()=>{t&&(o.editing.view.change(n=>{n.remove(t)}),t=null)})}class S{constructor(){this.modalInstance=null,this.modalElement=null,this.close=this.close.bind(this)}checkBootstrapAvailability(){return typeof bootstrap>"u"?(console.error("Bootstrap is not available. Make sure it is properly loaded."),!1):!0}open(e){if(!this.checkBootstrapAvailability())return!1;try{this.closeExistingModal();const r=document.createElement("div");r.innerHTML=e.trim();const t=r.querySelector("#aiModal");return t?(r.removeChild(t),document.body.appendChild(t),this.modalElement=t,this.modalInstance=new bootstrap.Modal(t,{backdrop:!0,keyboard:!0}),this.modalInstance.show(),this.setupCloseHandlers(t),!0):(console.error("Modal element #aiModal not found in the provided content"),!1)}catch(r){return console.error("Error opening modal:",r),!1}}setupCloseHandlers(e){e.querySelectorAll('.close, .btn-close, [data-bs-dismiss="modal"]').forEach(t=>{t.removeEventListener("click",this.close.bind(this)),t.addEventListener("click",this.close.bind(this))})}closeExistingModal(){try{this.modalInstance&&(this.modalInstance.hide(),this.modalInstance.dispose(),this.modalInstance=null),this.modalElement&&this.modalElement.parentNode&&this.modalElement.parentNode.removeChild(this.modalElement),document.querySelectorAll(".modal-backdrop").forEach(r=>{r&&r.parentNode&&r.parentNode.removeChild(r)}),document.body.classList.remove("modal-open"),document.body.style.removeProperty("padding-right"),document.body.style.removeProperty("overflow"),this.modalElement=null}catch(e){console.warn("Error disposing existing modal:",e)}}close(){try{this.modalInstance&&(this.modalInstance.hide(),this.modalInstance.dispose(),this.modalInstance=null),this.modalElement&&this.modalElement.parentNode&&this.modalElement.parentNode.removeChild(this.modalElement),this.modalElement=null}catch(e){console.warn("Error closing modal:",e),this.modalElement&&this.modalElement.parentNode&&this.modalElement.parentNode.removeChild(this.modalElement),document.querySelectorAll(".modal-backdrop").forEach(t=>{t.parentNode.removeChild(t)}),document.body.classList.remove("modal-open"),document.body.style.removeProperty("padding-right"),document.body.style.removeProperty("overflow")}}}async function R(o,e={}){const r=new URLSearchParams(e).toString(),t=`${o}?${r}`;try{const n=await fetch(t,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!n.ok)throw new Error(`Failed to fetch modal content: ${n.status} ${n.statusText}`);return await n.text()}catch(n){throw console.error("Error loading modal content:",n),n}}function P(o){if(!o||!o.model||!o.model.document)return console.warn("Editor not properly initialized when trying to save selection"),{ranges:[],attributes:[]};const e=o.model.document.selection,r=Array.from(e.getRanges()).map(n=>n.clone()),t=Array.from(e.getAttributes());return{ranges:r,attributes:t}}function k(o,e){if(!o||!o.model){console.warn("Editor not properly initialized when trying to restore selection");return}if(!e||!e.ranges){console.warn("Invalid saved selection when trying to restore");return}o.model.change(r=>{try{r.setSelection(e.ranges);for(const[t,n]of e.attributes)r.setSelectionAttribute(t,n)}catch(t){console.error("Error restoring editor selection:",t)}})}async function C(o,e,r="suggest_response",t=!1){var n;if(!e||!e.model){console.error("Editor not properly initialized");return}try{if(typeof bootstrap>"u"){console.error("Bootstrap is required but not available");return}o=b(o);const s=P(e);let a;const i=f(window.location.href);let d;i||(d=(n=document.querySelector("#ai-queue"))==null?void 0:n.getAttribute("data-id"));try{a=await R(RT.Config.WebHomePath+"/Helpers/AISuggestion/ShowModal",{rawText:o,callType:r,...i&&{TicketId:i},...d&&{QueueId:d}})}catch(u){console.error("Failed to load modal content:",u),alert("Failed to load AI suggestion modal. Please try again later.");return}const l=new S;if(!l.open(a)){console.error("Failed to open modal");return}setTimeout(()=>{try{const u=l.modalElement.querySelector('[name="done-button"]'),p=l.modalElement.querySelector('[name="ai-result"]');if(!p){console.error("suggestionText element not found in modal content");return}typeof htmx<"u"&&htmx.process(l.modalElement),u?(u.replaceWith(u.cloneNode(!0)),l.modalElement.querySelector('[name="done-button"]').addEventListener("click",()=>{var E;const y=(E=p==null?void 0:p.innerText)==null?void 0:E.replace(/^\s*|\s*$/g,"").trim();if(!y){console.warn("No AI response to insert"),l.close();return}try{e.model.change(c=>{try{const g=e.data.toModel(e.data.processor.toView(y));if(!s.ranges.length||!t){const w=e.model.document.getRoot();c.setSelection(null),c.remove(c.createRangeIn(w)),c.insert(g,c.createPositionAt(w,0))}else k(e,s),e.model.insertContent(g,e.model.document.selection);const F=e.model.document.getRoot(),D=c.createPositionAt(F,"end");c.setSelection(D),setTimeout(()=>{e.editing.view.focus()},100)}catch(g){console.error("Error inserting content into editor:",g),alert("Failed to insert AI suggestion into the editor.")}})}catch(c){console.error("Error applying editor changes:",c)}l.close()})):console.warn("Done button not found in modal content")}catch(u){console.error("Error setting up modal interaction:",u)}},100)}catch(s){console.error("Error creating suggestion modal:",s),alert("An error occurred while creating the AI suggestion modal.")}}class M extends CKEDITOR.Plugin{static get pluginName(){return"RtExtensionAi"}init(){const e=this.editor;v()&&(RT.AIEditorFeatures.some(r=>["adjust_tone","suggest_response","translate_content"].includes(r))&&this.addDropdown(e),RT.AIEditorFeatures.includes("autocomplete_text")&&this.addAutoComplete(e))}addDropdown(e){e.ui.componentFactory.add("aiSuggestion",r=>{const t=new CKEDITOR.Collection;RT.AIEditorFeatures.includes("adjust_tone")&&t.add(this.createDropdownItem("Adjust Tone/Voice","adjust_tone")),RT.AIEditorFeatures.includes("suggest_response")&&t.add(this.createDropdownItem("AI Suggestion","suggest_response")),RT.AIEditorFeatures.includes("translate_content")&&t.add(this.createDropdownItem("Translate","translate_content"));const n=CKEDITOR.createDropdown(r,CKEDITOR.DropdownButtonView);return CKEDITOR.addListToDropdown(n,t),n.buttonView.set({label:"AI Assist",tooltip:!0,withText:!0}),n.on("execute",async s=>{const{id:a}=s.source,{content:i,isSelected:d}=I(e);C(i,e,a,d)}),n})}addAutoComplete(e){let r=null,t=!1;e.model.document.on("change:data",()=>{clearTimeout(r),r=setTimeout(async()=>{if(t){t=!1;return}const n=T(e.data.get().trim());if(n)try{const s=await h(n,"autocomplete_text");s&&(A(e,s),t=!0)}catch(s){console.error("Error during auto-complete:",s)}},500)})}createDropdownItem(e,r){return{type:"button",model:{label:e,id:r,withText:!0}}}}m.RtExtensionAi=M,Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
